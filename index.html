<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,
            user-scalable=0" />
    <meta name="description" content="Query next available time slot">
    <meta name="author" content="Dawei Zhang">
    <!-- <link rel="icon" href="./myico"> -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.13.0/moment.min.js"></script>

    <style type="text/css">
        .col-sm-8 {
            padding-left: 0px;
            padding-right: 0px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">AV Services - Next Available Time</a>
    </nav>

    <!-- compensate the nav bar height -->
    <hr class="mt-2 mb-5" />

    <!-- Begin page content -->
    <main class="container" style="padding-bottom: 30px; padding-top: 30px">

        <form style="border: 2px solid #bbb; padding:20px;">
            <div class="form-group row mb-3"> </div>

            <div class="form-group row mb-3">
                <div class="form-group col-sm-10">
                    <input type="file" class="form-control-file" id="csv">
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- head row -->
                <label class="col-sm-2 col-form-label">Classroom:</label>
                <div class="col-sm-8">
                    <select class="form-control" id="sel1" name="classroom"> </select>
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- result rows -->
                <label class="col-sm-2 col-form-label">Availability:</label>
                <!-- <div class="col-sm-8"><textarea readonly class="form-control" name="description" id="ta1" placeholder="" style="height: 110px"></textarea></div> -->
                <div class="col-sm-8"><input readonly class="form-control" type="text" id="ta1"></input>
                </div>
            </div>

            <div id="cards">
                <!-- cards -->
                <div class="form-group row mb-3">
                    <label class="col-sm-2 col-form-label"></label>
                    <div class="card border-success col-sm-8">
                        <div class="card-header text-white bg-info">Mon</div>
                        <div class="card-body">
                            <div class="progress col-sm-14" id="card2-bar" style="height: 20px">
                                <div class="progress-bar" role="progressbar" style="width: 10%;"></div>
                                <div class="progress-bar bg-success" role="progressbar" style="width: 20%;"></div>
                                <div class="progress-bar bg-info" role="progressbar" style="width: 30%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>
    <footer class="footer" style="position: fixed; bottom: 0px; left: 0px; right: 0px; widows: 100%; background-color: #eee">
        <div class="container mb-3 mt-3" style="margin-left: 0px;">
            <span class="text-muted">
                <p style="font-size:medium; font-style: italic"> By Dawei Zhang, Copyright Â© 2019-2020, All rights reserved.</p>
            </span>
        </div>
    </footer>

    <script type="text/javascript">
        $(document).ready(function() {
            readFile();
        });

        var dataObj = []; // global list for all entries in csv database

        // set file open listener
        readFile = function() {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }

            var fileInput = document.getElementById("csv"),
                readFile = function() {
                    if (fileInput.files.length === 1) {
                        var reader = new FileReader();
                        reader.onload = function() {
                            csvToJsonObj(reader.result); // update "dataObj"
                            populateClassrooms();
                        };
                        // start reading the file. When it is done, calls the onload event defined above.
                        reader.readAsBinaryString(fileInput.files[0]);
                    }
                };
            fileInput.addEventListener('change', readFile);
        };

        // convert csv file to Json Object
        // https://stackoverflow.com/questions/28543821/convert-csv-lines-into-javascript-objects/28544299
        csvToJsonObj = function(csvResult) {
            dataObj = [];
            var arr = csvResult.split('\n');
            var headers = arr[0].split(',');
            for (var i = 1; i < arr.length; i++) {
                var data = arr[i].split(',');
                var obj = {};
                for (var j = 0; j < data.length && j < 8; j++) {
                    obj[headers[j].trim()] = data[j].trim();
                }
                if (obj["TERM"] !== "")
                    dataObj.push(obj);
                else
                    console.log("an empty entry");
            }
        }

        // file in "Classroom:" list
        populateClassrooms = function() {
            var classrooms = [];
            var output = [];
            dataObj.forEach(element => {
                if (classrooms.includes(element["ROOM"]) === false) {
                    classrooms.push(element["ROOM"]);
                    output.push('<option value="' + element["ROOM"] + '">' + element["ROOM"].replace(' ', '') + '</option>');
                }
            });
            $('#sel1').html(output.join(''));

            // listen to list item change event, update "Availability:" when changed
            var selClassroom = document.getElementById("sel1");
            selClassroom.addEventListener('change', findAvailableTimes);
        };

        // find Availability results
        findAvailableTimes = function() {
            const room = $("#sel1").val();
            //const theTime = moment();
            const theTime = moment("2019-10-07T16:34", "YYYY-MM-DDTHH:mm");
            const cpyTime = theTime.clone();
            const duration = 30 * 60 * 1000; // find time slot > duration (ms)

            var nextAvailable = [];
            for (var i = 0; i < 5; i++) {
                console.log(theTime.format("dddd, MMM DD, YY, H:mm"));
                const day = theTime.day();
                if ((day > 0 && day < 6) || (day > 7 && day < 10)) {
                    nextAvailable.push(findAvailableSlots(room, theTime, duration));
                    if (nextAvailable.length === 3) break;
                }
                theTime.add(1, 'day');
            }

            updateAvailability(nextAvailable);
            createCards(nextAvailable, cpyTime);
        };

        getDurationString = function(timeS, timeP) {
            const duration = moment.duration(timeP.diff(timeS));
            var hDuration = duration.hours();
            var mDuration = duration.minutes();
            var strDuration = "";
            if (hDuration !== 0)
                strDuration += hDuration + 'h';
            if (mDuration !== 0)
                strDuration += mDuration + 'm';
            return strDuration;
        }

        // update "Availability:" in widget
        updateAvailability = function(nextAvailable) {
            var output = [];
            $('#ta1').val("");
            for (var i = 0; i < nextAvailable.length; i++) {
                for (var j = 0; j < nextAvailable[i].length; j++) {
                    const timeS = moment(nextAvailable[i][j].start);
                    const timeP = moment(nextAvailable[i][j].end);
                    if (j === 0) {
                        output.push(timeS.format("ddd, MMM DD: "));
                    }
                    output.push(" [" + timeS.format("HH:mm") + "-" + timeP.format("HH:mm] (") + getDurationString(timeS, timeP) + ") ");
                }
            }
            $("#ta1").val(output.join(''));
        }

        // update cards
        createCards = function(nextAvailable, theTime) {
            var output = [];
            $('#cards').html("");
            for (var i = 0; i < nextAvailable.length; i++) {
                if (nextAvailable[i].length === 0) continue;
                var card = jQuery('<div class=\"form-group row mb-3\"></div>');
                const label = jQuery('<label class=\"col-sm-2 col-form-label\"></label>');
                card.append(label);

                var box = jQuery('<div class=\"card col-sm-8\"></div>');
                const timeChk = moment(nextAvailable[i][0].start);
                if (timeChk.day() === theTime.day())
                    box.addClass("border-success");
                else
                    box.addClass("border-info");

                const head = jQuery('<div class="card-header"></div>');
                if (timeChk.day() === theTime.day()) {
                    head.addClass("boarder-success");
                    head.append(timeChk.format("dddd") + " (Today)");
                } else {
                    head.addClass("boarder-info");
                    head.append(timeChk.format("dddd"));
                }

                var bars = jQuery('<div class=\"card-body\"></div>');
                var bars1 = jQuery('<div class=\"progress col-sm-14\" style=\"height: 25px\"></div>');
                const alldaylong = moment("19:00", "HH:mm").diff(moment("08:00", "HH:mm"));
                var timeBegin = moment("08:00", "HH:mm").year(timeChk.year()).month(timeChk.month()).date(timeChk.date());
                for (var j = 0; j < nextAvailable[i].length; j++) {
                    const timeS = moment(nextAvailable[i][j].start);
                    const timeP = moment(nextAvailable[i][j].end);
                    const diff1 = timeS.diff(timeBegin);
                    const diff2 = timeP.diff(timeS);
                    const barIdle = jQuery('<div class=\"progress-bar bg-light\" role=\"progressbar\" style=\"width: ' + Number(diff1 / alldaylong).toFixed(2) * 100 + '%\"></div>');
                    const barOk = jQuery('<div class=\"progress-bar\" role=\"progressbar\" style=\"text-align: left; width: ' + Number(diff2 / alldaylong).toFixed(2) * 100 + '%\"></div>');
                    if (timeChk.day() === theTime.day()) {
                        barOk.addClass("bg-success");
                    } else {
                        barOk.addClass("bg-info");
                    }
                    barOk.append(timeS.format("H:mm"));
                    bars1.append(barIdle);
                    bars1.append(barOk);
                    timeBegin = timeP;
                }
                bars.append(bars1);
                box.append(head);
                box.append(bars);
                card.append(box);
                $('#cards').append(card);
            }
        };

        // find available time for the day of "theTime"
        findAvailableSlots = function(room, theTime, duration) {

            // find the time list already reserved
            var reservedList = [];
            dataObj.forEach(element => {
                if (element["ROOM"] === room) {
                    const rsvdTime = timeReserved(element, theTime);
                    if (Object.entries(rsvdTime).length === 2) // {startTime, endTime}
                        reservedList.push(rsvdTime);
                    else if (Object.entries(rsvdTime).length !== 0)
                        console.error("multi slot in 1 entry");
                }
            });
            //console.log("reserved list:\n", reservedList);
            return reverseFindSlots("08:00", "19:00", reservedList, duration, theTime);
        };

        reverseFindSlots = function(onTimeStr, offTimeStr, reservedList, duration, theTime) {
            // find the time other than reserved time (8:00am - 19:00pm)
            const onTime = moment(onTimeStr, "HH:mm").year(theTime.year()).month(theTime.month()).date(theTime.date());
            const offTime = moment(offTimeStr, "HH:mm").year(theTime.year()).month(theTime.month()).date(theTime.date());
            var slotList = [];
            slotList.push({
                start: onTime,
                end: offTime
            });
            for (var i = 0; i < reservedList.length; i++) {
                const sTime = reservedList[i].start;
                const pTime = reservedList[i].end;
                for (var j = 0; j < slotList.length; j++) {
                    const on = moment(slotList[j].start);
                    const off = moment(slotList[j].end);
                    if (on.diff(sTime) <= (0 - duration) && off.diff(sTime) > 0) { // cut in slot
                        slotList[j].end = sTime;
                        if (off.diff(pTime) > (0 + duration)) {
                            slotList.push({
                                start: pTime,
                                end: off
                            });
                        } else {
                            //console.log("off bound:", off, pTime);
                        }
                    }
                }
            }
            console.log(slotList);
            return slotList;
        }

        // find reserved time in one entry
        timeReserved = function(element, theTime) {
            var startDate = element["DATES"].substring(0, 6);
            var endDate = element["DATES"].substring(9, 15);
            startDate = moment(startDate, "DD-MMM").set('hour', 8).set('minute', 0).set('second', 0).set('millisecond', 0);
            endDate = moment(endDate, "DD-MMM").set('hour', 19).set('minute', 0).set('second', 0).set('millisecond', 0);
            var dif1 = startDate.diff(theTime, 'minutes');
            var dif2 = endDate.diff(theTime, 'minutes');
            var days_time = element["MEETING TIMES"].split(' ');
            const wkdays = days_time[0];
            const hours = days_time[1];
            const targetDay = theTime.isoWeekday();
            var startTime = hours.substring(0, 2) + ":" + hours.substring(2, 4);
            var endTime = hours.substring(5, 7) + ":" + hours.substring(7, 9);
            startTime = moment(startTime, "HH:mm").year(theTime.year()).month(theTime.month()).date(theTime.date());
            endTime = moment(endTime, "HH:mm").year(theTime.year()).month(theTime.month()).date(theTime.date());
            //console.log(dif1, dif2);
            if ((dif1 < 0 && dif2 > 0) && // within the date period
                (wkdays === ("SU") && targetDay === 7) ||
                (wkdays === ("TR") && targetDay === 4) ||
                (wkdays === ("T") && targetDay === 2) ||
                (wkdays.includes("M") && targetDay === 1) ||
                (wkdays.includes("W") && targetDay === 3) || // find the work-day match
                (wkdays.includes("F") && targetDay === 5)
            ) {
                //console.log("Found", wkdays, startTime, endTime);
                return {
                    start: startTime,
                    end: endTime
                };
            }
            return {};
        }
    </script>
</body>

</html>