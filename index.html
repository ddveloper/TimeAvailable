<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,
            user-scalable=0" />
    <meta name="description" content="Query next available time slot">
    <meta name="author" content="Dawei Zhang">
    <!-- <link rel="icon" href="./myico"> -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <style type="text/css">

    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="/index">Next Time Available</a>
    </nav>

    <!-- compensate the nav bar height -->
    <hr class="mt-2 mb-5" />
    <hr class="mt-2 mb-5" />

    <!-- Begin page content -->
    <main class="container">

        <form style="border: 2px solid #bbb; padding-left:20px; padding-top: 15px">
            <div class="form-group row mb-3"> </div>

            <div class="form-group row mb-3">
                <!-- file input row -->
                <div class="form-group col-sm-10">
                    <input type="file" class="form-control-file" id="csv">
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- head row -->
                <label class="col-sm-2 col-form-label">Classroom:</label>
                <div class="col-sm-8">
                    <select class="form-control" id="sel1" name="classroom"> </select>
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- result rows -->
                <label class="col-sm-2 col-form-label">Availability:</label>
                <div class="col-sm-8"><textarea class="form-control" name="description" id="ta1" placeholder="x"></textarea></div>
            </div>

            <!-- 3 results -->
        </form>
    </main>

    <script type="text/javascript">
        $(document).ready(function() {
            readFile();
        });

        var dataObj = [];

        readFile = function() {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }

            var fileInput = document.getElementById("csv"),

                readFile = function() {
                    var reader = new FileReader();
                    reader.onload = function() {
                        dataObj = [];
                        // https://stackoverflow.com/questions/28543821/convert-csv-lines-into-javascript-objects/28544299
                        var arr = reader.result.split('\n');
                        var headers = arr[0].split(',');
                        for (var i = 1; i < arr.length; i++) {
                            var data = arr[i].split(',');
                            var obj = {};
                            for (var j = 0; j < data.length && j < 8; j++) {
                                obj[headers[j].trim()] = data[j].trim();
                            }
                            if (obj["TERM"] !== "")
                                dataObj.push(obj);
                            else
                                console.log("an empty entry");
                        }
                        populateClassrooms();
                    };
                    // start reading the file. When it is done, calls the onload event defined above.
                    reader.readAsBinaryString(fileInput.files[0]);
                };

            fileInput.addEventListener('change', readFile);
        };

        populateClassrooms = function() {
            var classrooms = [];
            var output = [];
            dataObj.forEach(element => {
                if (classrooms.includes(element["ROOM"]) == false) {
                    classrooms.push(element["ROOM"]);
                    output.push('<option value="' + element["ROOM"] + '">' + element["ROOM"] + '</option>');
                }
            });
            $('#sel1').html(output.join(''));
            var selClassroom = document.getElementById("sel1");
            selClassroom.addEventListener('change', updateAvailableTime);
        };

        updateAvailableTime = function() {
            $("#ta1").text("hello");
        };
    </script>
</body>

</html>