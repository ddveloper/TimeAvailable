<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,
            user-scalable=0" />
    <meta name="description" content="Query next available time slot">
    <meta name="author" content="Dawei Zhang">
    <!-- <link rel="icon" href="./myico"> -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.13.0/moment.min.js"></script>

    <style type="text/css">

    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="/index">Next Time Available</a>
    </nav>

    <!-- compensate the nav bar height -->
    <hr class="mt-2 mb-5" />
    <hr class="mt-2 mb-5" />

    <!-- Begin page content -->
    <main class="container">

        <form style="border: 2px solid #bbb; padding-left:20px; padding-top: 15px">
            <div class="form-group row mb-3"> </div>

            <div class="form-group row mb-3">
                <!-- file input row -->
                <div class="form-group col-sm-10">
                    <input type="file" class="form-control-file" id="csv">
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- head row -->
                <label class="col-sm-2 col-form-label">Classroom:</label>
                <div class="col-sm-8">
                    <select class="form-control" id="sel1" name="classroom"> </select>
                </div>
            </div>

            <div class="form-group row mb-3">
                <!-- result rows -->
                <label class="col-sm-2 col-form-label">Availability:</label>
                <div class="col-sm-8"><textarea class="form-control" name="description" id="ta1" placeholder="x"></textarea></div>
            </div>

            <!-- 3 results -->
        </form>
    </main>

    <script type="text/javascript">
        $(document).ready(function() {
            readFile();
        });

        var dataObj = [];

        readFile = function() {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }

            var fileInput = document.getElementById("csv"),

                readFile = function() {
                    var reader = new FileReader();
                    reader.onload = function() {
                        dataObj = [];
                        // https://stackoverflow.com/questions/28543821/convert-csv-lines-into-javascript-objects/28544299
                        var arr = reader.result.split('\n');
                        var headers = arr[0].split(',');
                        for (var i = 1; i < arr.length; i++) {
                            var data = arr[i].split(',');
                            var obj = {};
                            for (var j = 0; j < data.length && j < 8; j++) {
                                obj[headers[j].trim()] = data[j].trim();
                            }
                            if (obj["TERM"] !== "")
                                dataObj.push(obj);
                            else
                                console.log("an empty entry");
                        }
                        populateClassrooms();
                    };
                    // start reading the file. When it is done, calls the onload event defined above.
                    reader.readAsBinaryString(fileInput.files[0]);
                };

            fileInput.addEventListener('change', readFile);
        };

        populateClassrooms = function() {
            var classrooms = [];
            var output = [];
            dataObj.forEach(element => {
                if (classrooms.includes(element["ROOM"]) === false) {
                    classrooms.push(element["ROOM"]);
                    output.push('<option value="' + element["ROOM"] + '">' + element["ROOM"].replace(' ', '') + '</option>');
                }
            });
            $('#sel1').html(output.join(''));
            var selClassroom = document.getElementById("sel1");
            selClassroom.addEventListener('change', updateAvailableTime);
        };

        updateAvailableTime = function() {
            const room = $("#sel1").val();
            //const theTime = moment();
            const theTime = moment("2019-10-07T16:34", "YYYY-MM-DDTHH:mm");
            const nextAvailable1 = findAvailableTime(room, theTime);

            $("#ta1").text($("#sel1").val());
        };

        findAvailableTime = function(room, theTime) {
            var found = 0;
            dataObj.forEach(element => {
                if (element["ROOM"] === room) {
                    var startDate = element["DATES"].substring(0, 6);
                    var endDate = element["DATES"].substring(9, 15);
                    startDate = moment(startDate, "DD-MMM").set('hour', 8).set('minute', 0).set('second', 0).set('millisecond', 0);
                    endDate = moment(endDate, "DD-MMM").set('hour', 19).set('minute', 0).set('second', 0).set('millisecond', 0);
                    var dif1 = startDate.diff(theTime, 'minutes');
                    var dif2 = endDate.diff(theTime, 'minutes');
                    //console.log(dif1, dif2);
                    if (dif1 < 0 && dif2 > 0) { // within the period
                        var days_time = element["MEETING TIMES"].split(' ');
                        const wkdays = days_time[0];
                        const hours = days_time[1];
                        const targetDay = theTime.isoWeekday();
                        if ((wkdays === ("SU") && targetDay === 7) ||
                            (wkdays === ("TR") && targetDay === 4) ||
                            (wkdays === ("T") && targetDay === 2) ||
                            (wkdays.includes("M") && targetDay === 1) ||
                            (wkdays.includes("W") && targetDay === 3) ||
                            (wkdays.includes("F") && targetDay === 5)
                        ) { // find the day match
                            var startTime = hours.substring(0, 2) + ":" + hours.substring(2, 4);
                            var endTime = hours.substring(5, 7) + ":" + hours.substring(7, 9);
                            startTime = moment(startTime, "HH:mm");
                            endTime = moment(endTime, "HH:mm");
                            console.log("Found", wkdays, startTime, endTime);
                        }
                    }
                }
            });
        };
    </script>
</body>

</html>